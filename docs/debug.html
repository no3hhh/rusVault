<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YT Debug v7</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, sans-serif; background:#0a0a14; color:#e8e8f0; padding:20px; }
h1 { font-size:18px; color:#e94560; margin-bottom:16px; }
input { width:100%; padding:12px; background:#1a1a2e; border:1px solid #2a2a3e; border-radius:10px; color:#e8e8f0; font-size:15px; margin-bottom:12px; outline:none; }
button { padding:12px 20px; background:#e94560; color:#fff; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; width:100%; margin-bottom:16px; }
.log { background:#12121f; border-radius:10px; padding:14px; font-family:'Courier New',monospace; font-size:12px; line-height:1.8; max-height:70vh; overflow-y:auto; white-space:pre-wrap; word-break:break-all; }
.ok { color:#4ecca3; } .err { color:#e94560; } .warn { color:#f0c040; } .info { color:#5b8def; }
</style>
</head>
<body>
<h1>üîç YT Debug v7 ‚Äî Piped + alternatives</h1>
<input type="url" id="url" placeholder="https://youtube.com/watch?v=‚Ä¶">
<button onclick="runTest()">Tester</button>
<div class="log" id="log">En attente‚Ä¶</div>
<script>
var logEl = document.getElementById('log');
function out(msg, cls) { var d = document.createElement('div'); if (cls) d.className = cls; d.textContent = msg; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }
function fetchT(url, ms) { var t = new Promise(function(_, rej) { setTimeout(function() { rej(new Error('timeout')); }, ms || 8000); }); return Promise.race([fetch(url), t]); }
function extractId(url) { var m = url.match(/(?:v=|youtu\.be\/|\/shorts\/)([a-zA-Z0-9_-]{11})/); return m ? m[1] : null; }

async function runTest() {
  logEl.innerHTML = '';
  var vid = extractId(document.getElementById('url').value.trim());
  if (!vid) { out('URL invalide', 'err'); return; }
  out('Video ID: ' + vid, 'ok');

  // ‚ïê‚ïê PIPED API ‚ïê‚ïê
  out('');
  out('== STRATEGIE 1: Piped API ==', 'info');
  out('(Piped renvoie les sous-titres avec URL directe)', '');

  var pipedInstances = [
    'https://pipedapi.kavin.rocks',
    'https://pipedapi.adminforge.de',
    'https://pipedapi.in.projectsegfau.lt',
    'https://api.piped.yt',
    'https://pipedapi.darkness.services'
  ];

  for (var i = 0; i < pipedInstances.length; i++) {
    var pBase = pipedInstances[i];
    out('');
    out('-- ' + pBase + ' --', 'info');
    try {
      var r = await fetchT(pBase + '/streams/' + vid, 10000);
      out('  HTTP: ' + r.status, r.ok ? 'ok' : 'err');
      if (!r.ok) continue;
      var data = await r.json();
      var subs = data.subtitles || [];
      out('  ' + subs.length + ' subtitle(s)', subs.length > 0 ? 'ok' : 'warn');

      for (var j = 0; j < subs.length; j++) {
        var s = subs[j];
        var isRu = (s.code === 'ru') || (s.name || '').toLowerCase().indexOf('russian') > -1;
        out('    [' + (s.code || '?') + '] "' + (s.name || '') + '" auto=' + (s.autoGenerated || false) + ' mime=' + (s.mimeType || '?') + (isRu ? ' << RUSSE' : ''), isRu ? 'ok' : '');
        
        if (isRu && s.url) {
          out('    URL: ' + s.url.substring(0, 120) + '...');
          // Try to fetch the actual content
          try {
            var sr = await fetchT(s.url, 8000);
            out('    Fetch HTTP: ' + sr.status, sr.ok ? 'ok' : 'err');
            if (sr.ok) {
              var txt = await sr.text();
              out('    Taille: ' + txt.length + ' chars', txt.length > 50 ? 'ok' : 'err');
              if (txt.length > 0) {
                out('    Apercu: ' + txt.substring(0, 400), txt.length > 50 ? 'ok' : 'warn');
              }
              if (txt.length > 50 && txt.toLowerCase().indexOf('sorry') === -1) {
                out('    >>> PIPED FONCTIONNE ! <<<', 'ok');
              }
            }
          } catch (e) {
            out('    Fetch err: ' + e.message, 'err');
            // Try via CORS proxy
            out('    Essai via codetabs proxy...');
            try {
              var pr = await fetchT('https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(s.url), 8000);
              if (pr.ok) {
                var ptxt = await pr.text();
                out('    Proxy taille: ' + ptxt.length + ' chars', ptxt.length > 50 ? 'ok' : 'err');
                if (ptxt.length > 0) {
                  out('    Proxy apercu: ' + ptxt.substring(0, 400), ptxt.length > 50 ? 'ok' : 'warn');
                }
              }
            } catch (pe) { out('    Proxy err: ' + pe.message, 'err'); }
          }
        }
      }
    } catch (e) {
      out('  Erreur: ' + e.message, 'err');
    }
  }

  // ‚ïê‚ïê COBALT API ‚ïê‚ïê
  out('');
  out('== STRATEGIE 2: Cobalt ==', 'info');
  // Cobalt doesn't do subtitles, but let's try a transcript API

  // ‚ïê‚ïê youtubetranscript.com API ‚ïê‚ïê
  out('');
  out('== STRATEGIE 3: Direct timedtext via CORS proxy ==', 'info');
  out('On construit l\'URL timedtext directement', '');

  var timedtextUrl = 'https://www.youtube.com/api/timedtext?v=' + vid + '&lang=ru&fmt=vtt';
  var timedtextUrlAuto = 'https://www.youtube.com/api/timedtext?v=' + vid + '&lang=ru&kind=asr&fmt=vtt';
  var timedtextJson = 'https://www.youtube.com/api/timedtext?v=' + vid + '&lang=ru&fmt=json3';
  var timedtextAutoJson = 'https://www.youtube.com/api/timedtext?v=' + vid + '&lang=ru&kind=asr&fmt=json3';
  
  var ttUrls = [
    ['timedtext ru VTT', timedtextUrl],
    ['timedtext ru auto VTT', timedtextUrlAuto],
    ['timedtext ru JSON3', timedtextJson],
    ['timedtext ru auto JSON3', timedtextAutoJson]
  ];

  var proxyFn = function(u) { return 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(u); };

  for (var t = 0; t < ttUrls.length; t++) {
    out('');
    out('-- ' + ttUrls[t][0] + ' --', 'info');
    out('  URL: ' + ttUrls[t][1]);
    try {
      var tr = await fetchT(proxyFn(ttUrls[t][1]), 8000);
      out('  HTTP: ' + tr.status, tr.ok ? 'ok' : 'err');
      if (tr.ok) {
        var ttxt = await tr.text();
        var isError = ttxt.toLowerCase().indexOf('sorry') > -1;
        out('  Taille: ' + ttxt.length + ' chars' + (isError ? ' (Google Sorry!)' : ''), (!isError && ttxt.length > 50) ? 'ok' : 'err');
        if (ttxt.length > 0 && ttxt.length < 500) {
          out('  Contenu: ' + ttxt, 'warn');
        } else if (ttxt.length >= 500 && !isError) {
          out('  Apercu: ' + ttxt.substring(0, 400), 'ok');
          out('  >>> CA MARCHE ! <<<', 'ok');
        }
      }
    } catch (e) {
      out('  Erreur: ' + e.message, 'err');
    }
  }

  out('');
  out('== TERMINE ==', 'info');
}
</script>
</body>
</html>
