<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YT Debug v6</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, sans-serif; background:#0a0a14; color:#e8e8f0; padding:20px; }
h1 { font-size:18px; color:#e94560; margin-bottom:16px; }
input { width:100%; padding:12px; background:#1a1a2e; border:1px solid #2a2a3e; border-radius:10px; color:#e8e8f0; font-size:15px; margin-bottom:12px; outline:none; }
button { padding:12px 20px; background:#e94560; color:#fff; border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; width:100%; margin-bottom:16px; }
.log { background:#12121f; border-radius:10px; padding:14px; font-family:'Courier New',monospace; font-size:12px; line-height:1.8; max-height:70vh; overflow-y:auto; white-space:pre-wrap; word-break:break-all; }
.ok { color:#4ecca3; } .err { color:#e94560; } .warn { color:#f0c040; } .info { color:#5b8def; }
</style>
</head>
<body>
<h1>üîç YT Debug v6 ‚Äî test all formats</h1>
<input type="url" id="url" placeholder="https://youtube.com/watch?v=‚Ä¶">
<button onclick="runTest()">Tester</button>
<div class="log" id="log">En attente‚Ä¶</div>
<script>
var logEl = document.getElementById('log');
function out(msg, cls) { var d = document.createElement('div'); if (cls) d.className = cls; d.textContent = msg; logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight; }
function fetchT(url, ms) { var t = new Promise(function(_, rej) { setTimeout(function() { rej(new Error('timeout')); }, ms || 8000); }); return Promise.race([fetch(url), t]); }
function extractId(url) { var m = url.match(/(?:v=|youtu\.be\/|\/shorts\/)([a-zA-Z0-9_-]{11})/); return m ? m[1] : null; }

async function runTest() {
  logEl.innerHTML = '';
  var vid = extractId(document.getElementById('url').value.trim());
  if (!vid) { out('URL invalide', 'err'); return; }
  out('Video ID: ' + vid, 'ok');
  out('');

  var base = 'https://inv.nadeko.net';
  out('== ' + base + ' ==', 'info');

  try {
    var r = await fetchT(base + '/api/v1/captions/' + vid, 8000);
    out('HTTP: ' + r.status, r.ok ? 'ok' : 'err');
    if (!r.ok) return;
    var data = await r.json();
    var caps = data.captions || [];
    out(caps.length + ' caption(s)', 'ok');
    out('');

    // Show raw JSON for each caption
    out('== RAW CAPTION DATA ==', 'info');
    for (var i = 0; i < caps.length; i++) {
      out('Caption ' + i + ': ' + JSON.stringify(caps[i]), 'warn');
    }
    out('');

    // Find Russian captions
    var ruCaps = [];
    for (var i = 0; i < caps.length; i++) {
      var lb = (caps[i].label || '').toLowerCase();
      if (lb.indexOf('russian') > -1 || lb.indexOf('—Ä—É—Å—Å') > -1 || lb.indexOf('russe') > -1) {
        ruCaps.push(caps[i]);
      }
    }
    out(ruCaps.length + ' piste(s) russe(s)', 'info');
    out('');

    // For each Russian caption, try ALL formats
    var formats = ['vtt', 'json3', 'srv3', 'ttml', ''];
    
    for (var j = 0; j < ruCaps.length; j++) {
      var cap = ruCaps[j];
      out('=== "' + cap.label + '" ===', 'info');
      out('URL brute: ' + cap.url);
      out('');

      for (var f = 0; f < formats.length; f++) {
        var fmt = formats[f];
        var subUrl = base + cap.url;
        if (fmt) {
          // Remove existing fmt if any, add new one
          subUrl = subUrl.replace(/[&?]fmt=[^&]*/, '');
          subUrl += (subUrl.indexOf('?') > -1 ? '&' : '?') + 'fmt=' + fmt;
        }
        
        out('  Format "' + (fmt || 'default') + '":', 'info');
        out('  URL: ' + subUrl.substring(0, 140));

        try {
          var sr = await fetchT(subUrl, 8000);
          out('  HTTP: ' + sr.status, sr.ok ? 'ok' : 'err');
          if (!sr.ok) { out(''); continue; }
          var txt = await sr.text();
          out('  Taille: ' + txt.length + ' chars', txt.length > 50 ? 'ok' : 'err');
          if (txt.length > 0 && txt.length <= 500) {
            out('  Contenu: ' + txt, txt.length > 50 ? 'ok' : 'warn');
          } else if (txt.length > 500) {
            out('  Apercu: ' + txt.substring(0, 400), 'ok');
            out('  >>> SUCCES ! Format "' + (fmt || 'default') + '" fonctionne <<<', 'ok');
          }
        } catch (e) {
          out('  Erreur: ' + e.message, 'err');
        }
        out('');
      }
    }

    // Also try direct video endpoint
    out('');
    out('== TEST: endpoint /api/v1/videos ==', 'info');
    try {
      var vr = await fetchT(base + '/api/v1/videos/' + vid + '?fields=captions', 8000);
      out('HTTP: ' + vr.status, vr.ok ? 'ok' : 'err');
      if (vr.ok) {
        var vd = await vr.text();
        out('Taille: ' + vd.length + ' chars');
        out('Contenu: ' + vd.substring(0, 500), 'warn');
      }
    } catch (e) { out('Erreur: ' + e.message, 'err'); }

  } catch (e) {
    out('Erreur: ' + e.message, 'err');
  }

  out('');
  out('== TERMINE ==', 'info');
}
</script>
</body>
</html>
